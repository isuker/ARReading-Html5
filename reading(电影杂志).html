<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Inception - Reading</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <!--<link href="bootstrap/bootstrap.css" rel="stylesheet">-->
        <style>
            html{background: transparent url(Image/background_1.jpg);color:#000}
            /*body{margin:0;padding:0;margin-top:20px;text-align:center}*/
            body{margin:0;padding:0;}
            /*#loading{font-size:80px;font-weight:bold;font-family:Times}*/
        </style>
        <script src="Js/3rdParty/JSARToolKit.js"></script>
        <script src="Js/3rdParty/(old)three.js"></script>
        <!--<script src="Js/3rdParty/three.min.js"></script>-->
        <script src="Js/Inception.js"></script>
        <script src="Js/Jsar.js"></script>
        <script src="Js/Models.js"></script>
        <script src="Js/Webcam.js"></script>
        <!--<script src="Js/Stats.js"></script>-->
        <script>
            //DEBUG = true;     // global var for JSAR
            var threshold = 90;

            var scaleRate = 1.5;    //显示.放大尺寸比例
            //var HEIGHT = 320;
            var HEIGHT = 480;       //webcam尺寸
            var WIDTH = HEIGHT*4/3;

            //

            //var stats;
            var container;
            var canvas, camCanvas, videoCanvas;
            var webcam, video;
            var camTex, videoTex, imageTex;
            var model_obj;//=new THREE.Ob.Object3D();

            var ctx;
            var renderer, projector;
            var scene, camera;
            var webcamScene, webcamCam;

            var Jsar, Models;

            projector = new THREE.Projector();

            function createElements() {
                container = document.getElementById('container');

                // create video for AR
                video = document.createElement('video');
                video.src = 'Uploads/video/webm/shwj5.webm';
                video.width = 320;
                video.height = 240;
                video.loop = true;
                video.style.display = 'none';
                video.controls = true;

                // create webcam
                webcam = document.createElement('video');
                webcam.style.display = 'none';
                webcam.width = WIDTH;
                webcam.height = HEIGHT;
                webcam.videoWidth = WIDTH;
                webcam.videoHeight = HEIGHT;
                webcam.loop = true;
                webcam.volume = 0;
                webcam.autoplay = true;
                //webcam.controls = true;
                AR.Webcam(webcam);

                // create video Canvas
                videoCanvas = document.createElement('canvas');
                videoCanvas.width = video.width;    //320
                videoCanvas.height = video.height;   //  240
                videoTex = new THREE.Texture(videoCanvas);

                //create main canvas
                canvas = document.createElement('canvas');
                canvas.width = WIDTH;
                canvas.height = HEIGHT;

                //create camCanvas
                camCanvas = document.createElement('canvas');
                camCanvas.width = webcam.width;
                camCanvas.height = webcam.height;
                camTex = new THREE.Texture(camCanvas);

                // canvas ctx
                ctx = canvas.getContext('2d');
                ctx.font = "24px URW Gothic L, Arial, Sans-serif";

                // show fps
//                stats = new Stats();
//                stats.domElement.style.position = 'absolute';
//                stats.domElement.style.top = '0px';
//                container.appendChild( stats.domElement );
            }
            function loadModels() {
                Models = new AR.Models(projector, camera);
                //  load model for each marker
                Models.addModel(0, new THREE.Mesh(new THREE.PlaneGeometry(160*1.4, 120*1.4, 0), new THREE.MeshBasicMaterial({
                    map: videoTex
                })), AR.Models.ModelType.video, function(e){
                    if(e.clickCount%2)
                        video.play();
                    else
                        video.pause();
                });
            }
            // 初始化 3d 跟 AR
            function init() {
                Jsar = new AR.Jsar(canvas, WIDTH, HEIGHT, threshold, 3);
                // THREE.JS
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(WIDTH*scaleRate, HEIGHT*scaleRate);
                var glCanvas = renderer.domElement;
                container.appendChild(glCanvas);    //  add Renderer-canvas to container
                scene = new THREE.Scene();
                var light = new THREE.PointLight(0xffffff);
                light.position.set(400, 500, 100);
                scene.add(light);
                light.position.set( - 400, -500, -100);
                scene.add(light);
                //camera = new THREE.Camera();
                camera = new THREE.PerspectiveCamera( 80, WIDTH / HEIGHT, 10, 10000 );
                scene.add(camera);
                var ARMat = Jsar.getARMat();
                camera.projectionMatrix.setFromArray(ARMat);
                var plane = new THREE.Mesh(new THREE.PlaneGeometry(2, 2, 0), new THREE.MeshBasicMaterial({
                    map: camTex
                }));
                plane.material.depthTest = false;
                plane.material.depthWrite = false;
                webcamCam = new THREE.Camera();
                webcamScene = new THREE.Scene();
                webcamScene.add(plane);
                webcamScene.add(webcamCam);
            }
            // 动画效果
            function animate() {
                //requestAnimationFrame( animate );   // 类似 setTimeout(renderLoop, PERIOD); // 实测 fps 太低
                render();
                //stats.update(); //显示 fps
            }
            // 渲染
            function render() {
                // detecting...Loop
                camCanvas.getContext('2d').drawImage(webcam, 0, 0);
                ctx.drawImage(camCanvas, 0, 0, WIDTH, HEIGHT);
                canvas.changed = true;
                camTex.needsUpdate = true;

                //  更新视频当前帧到canvas，再更新视频纹理。
                videoCanvas.getContext('2d').drawImage(video, 0, 0);
                videoTex.needsUpdate = true;

                var markers = Jsar.detect(scene);
                //  增强虚拟obj
                for (var i in markers) {
                    var m = markers[i];
                    if (!m.model) {     //分配 model
                        m.model = new THREE.Object3D();
                        var cube = Models.getModel(i);
                        //cube.position.z = 0;
                        //cube.position.z = -50;
                        cube.doubleSided = true;
                        m.model.matrixAutoUpdate = false;
                        m.model.add(cube);
                        //var floor = new THREE.Mesh(new THREE.PlaneGeometry(120, 120, 0), new THREE.MeshBasicMaterial({color:0x00}));
                        //m.model.add(floor);
                        scene.add(m.model); //add to scene
                    }
                    var ARMat = new Float32Array(16);
                    Jsar.copyMatrix(m.transform, ARMat);   // ARmat -> GLmat
                    m.model.matrix.setFromArray(ARMat);
                    m.model.matrixWorldNeedsUpdate = true;
                }
                renderer.autoClear = false;
                renderer.clear();
                renderer.render(webcamScene, webcamCam);
                renderer.render(scene, camera);
            }

            // onload - 入口点
            window.onload = function() {
                //  !!Main
                createElements();
                loadModels();
                init();
                document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                //window.addEventListener( 'resize', onWindowResize, false );
                setInterval(animate, 15);    // 1000/15=67 fps
            }
            // events
            function onDocumentMouseDown( event ) {
                event.preventDefault();
                //var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
                var vector = new THREE.Vector3( ( event.clientX / (WIDTH*scaleRate) ) * 2 - 1, - ( event.clientY / (HEIGHT*scaleRate) ) * 2 + 1, 0.5 );
                projector.unprojectVector( vector, camera );    //摄像头标定，分解投影矩阵
                var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
                var point = Models.intersect(ray);
            }
        </script>
    </head>
    
    <body>
        <noscript>
            <div style="display:block">
                Your browser does not support JavaScript!
            </div>
        </noscript>
        <div id="loading">
            loading...
        </div>
        <div id="container">

        </div>

        <!--&lt;!&ndash; Placed at the end of the document so the pages load faster &ndash;&gt;-->
        <!--<script src="bootstrap/js/jquery.js"></script>-->
        <!--&lt;!&ndash; bootstrap js plugin &ndash;&gt;-->
        <!--<script src="bootstrap/js/bootstrap.min.js"></script>-->

    </body>

</html>



            <!--    模态窗口    &lt;!&ndash;Model width="100%" height="400"&ndash;&gt;-->
            <!--<div id="youku" class="modal hide fade">-->
                <!--<div class="modal-body">-->
                    <!--<embed src="http://player.youku.com/player.php/sid/XMzIwMDU5MzQ0/v.swf" allowFullScreen="true" quality="high" width="100%" height="400" align="middle" allowScriptAccess="always" type="application/x-shockwave-flash"></embed>-->
                <!--</div>-->
            <!--</div>-->
            <!--<img src="images/video-thumb.png" width="450" height="272" data-toggle="modal" href="#youku" class="btn btn-primary btn-large" />-->