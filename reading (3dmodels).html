<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Inception - Reading</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            html{background:#fff;color:#000}body{margin:0;padding:0;margin-top:20px;text-align:center}#loading{font-size:80px;font-weight:bold;font-family:Times}
        </style>
        <script src="Js/3rdParty/JSARToolKit.js"></script>
        <script src="Js/3rdParty/Three.js"></script>
        <script src="Js/Inception.js"></script>
        <script src="Js/Jsar.js"></script>
        <script src="Js/Models.js"></script>
        <script src="Js/Webcam.js"></script>
        <script src="Js/Stats.js"></script>
        <script src="Js/3rdParty/Three.min.js"></script>
        <script src="Js/OBJLoader.js"></script>
        <script>
            //DEBUG = true;     // global var for JSAR
            var threshold = 90;

            var scaleRate = 1.5;
            //var HEIGHT = 320;
            var HEIGHT = 480;
            var WIDTH = HEIGHT*4/3;

            //

            var stats;
            var container;
            var canvas, camCanvas, videoCanvas;
            var webcam, video;
            var camTex, videoTex, imageTex;
            //var model_obj=new THREE.Object3D();
			var model_obj;
			var move_obj=new THREE.Object3D() ,deathwing=new THREE.Object3D();

            var ctx;
            var renderer, projector;
            var scene, camera;
            var webcamScene, webcamCam;

            var Jsar, Models;

            projector = new THREE.Projector();

            function createElements() {
                container = document.getElementById('container');

                // create video for AR
                video = document.createElement('video');
                video.src = 'textures/sintel.mp4';
                video.width = 320;
                video.height = 240;
                video.loop = true;
                video.style.display = 'none';
                video.controls = true;

                // create webcam
                webcam = document.createElement('video');
                webcam.style.display = 'none';
                webcam.width = WIDTH;
                webcam.height = HEIGHT;
                webcam.videoWidth = WIDTH;
                webcam.videoHeight = HEIGHT;
                webcam.loop = true;
                webcam.volume = 0;
                webcam.autoplay = true;
                //webcam.controls = true;
                AR.Webcam(webcam);

                // create video Canvas
                videoCanvas = document.createElement('canvas');
                videoCanvas.width = video.width;    //320
                videoCanvas.height = video.height;   //  240
                videoTex = new THREE.Texture(videoCanvas);

                //create main canvas
                canvas = document.createElement('canvas');
                canvas.width = WIDTH;
                canvas.height = HEIGHT;

                //create camCanvas
                camCanvas = document.createElement('canvas');
                camCanvas.width = webcam.width;
                camCanvas.height = webcam.height;
                camTex = new THREE.Texture(camCanvas);

                // canvas ctx
                ctx = canvas.getContext('2d');
                ctx.font = "24px URW Gothic L, Arial, Sans-serif";

                // show fps
                stats = new Stats();
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.top = '0px';
                container.appendChild( stats.domElement );
            }
            function loadModels() {
                Models = new AR.Models(projector, camera);
                //  load model for each marker
                Models.addModel(0, deathwing,AR.Models.ModelType.obj3d);
                Models.addModel(14,model_obj,AR.Models.ModelType.obj3d);
                Models.addModel(21, death, AR.Models.ModelType.obj3d);
                Models.addModel(91, new THREE.Mesh(new THREE.PlaneGeometry(120, 120, 0), new THREE.MeshBasicMaterial({
                    color: 0xffff
                })), AR.Models.ModelType.button);
            }
            // 初始化 3d 跟 AR
            function init() {
                Jsar = new AR.Jsar(canvas, WIDTH, HEIGHT, threshold, 3);
                // THREE.JS
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(WIDTH*scaleRate, HEIGHT*scaleRate);
                var glCanvas = renderer.domElement;
                container.appendChild(glCanvas);    //  add Renderer-canvas to container
                scene = new THREE.Scene();
                var light = new THREE.PointLight(0xffffff);
                light.position.set(400, 500, 100);
                scene.add(light);
                light.position.set( - 400, -500, -100);
                scene.add(light);
                camera = new THREE.Camera();
                scene.add(camera);
                var ARMat = Jsar.getARMat();
                camera.projectionMatrix.setFromArray(ARMat);
                var plane = new THREE.Mesh(new THREE.PlaneGeometry(2, 2, 0), new THREE.MeshBasicMaterial({
                    map: camTex
                }));
                plane.material.depthTest = false;
                plane.material.depthWrite = false;
                webcamCam = new THREE.Camera();
                webcamScene = new THREE.Scene();
                webcamScene.add(plane);
                webcamScene.add(webcamCam);
            }
            // 动画效果
            function animate() {
                //requestAnimationFrame( animate );   // 类似 setTimeout(renderLoop, PERIOD); // 实测 fps 太低
                render();
                stats.update(); //显示 fps
            }
            // 渲染
            function render() {
                // detecting...Loop
                camCanvas.getContext('2d').drawImage(webcam, 0, 0);
                ctx.drawImage(camCanvas, 0, 0, WIDTH, HEIGHT);
                canvas.changed = true;
                camTex.needsUpdate = true;

                //  更新视频当前帧到canvas，再更新视频纹理。
                videoCanvas.getContext('2d').drawImage(video, 0, 0);
                videoTex.needsUpdate = true;

                var markers = Jsar.detect(scene);
                //  增强虚拟obj
                for (var i in markers) {
                    var m = markers[i];
                    if (!m.model) {     //分配 model
                        m.model = new THREE.Object3D();
//                        var cube = new THREE.Mesh(new THREE.PlaneGeometry(120, 120, 0), new THREE.MeshBasicMaterial({
//                            map: videoTex
//                        }));
                        //cube.position.z = -50;
                        var cube = Models.getModel(i);
                        cube.position.z = 0;
                        cube.doubleSided = true;
                        m.model.matrixAutoUpdate = false;
                        m.model.add(cube);
                        scene.add(m.model); //add to scene
                    }
                    var ARMat = new Float32Array(16);
                    Jsar.copyMatrix(m.transform, ARMat);   // ARmat -> GLmat
                    m.model.matrix.setFromArray(ARMat);
                    m.model.matrixWorldNeedsUpdate = true;
                }
                renderer.autoClear = false;
                renderer.clear();
                renderer.render(webcamScene, webcamCam);
                renderer.render(scene, camera);
            }

            // onload - 入口点
			var texture = new THREE.Texture(), newtext=new THREE.Texture() ,object,sobject;
            window.onload = function() {
				
				
                var loader = new THREE.JSONLoader(true);
                loader.load("models/monster2.js", function ( geometry ) {
					
					geometry.applyMatrix((new THREE.Matrix4).identity().rotateX(-Math.PI/2));
					geometry.applyMatrix((new THREE.Matrix4).identity().rotateZ(Math.PI));
					geometry.applyMatrix((new THREE.Matrix4).identity().makeTranslation(0, 0, 0));
                    model_obj = new THREE.Mesh(geometry, new THREE.MeshPhongMaterial( { ambient: 0x030303, color: 0xffff, specular: 0x666666, shininess: 10 } ) );
                    model_obj.scale.set(8,8,8);
					
					//
						
					var text_loader = new THREE.ImageLoader();
					text_loader.addEventListener( 'load', function ( event ) {
	
						texture.image = event.content;
						texture.needsUpdate = true;
	
					} );
					text_loader.load( 'textures/ash_uvgrid01.jpg' );
					
					var obj_loader = new THREE.OBJLoader();
					obj_loader.addEventListener( 'load', function ( event ) {
	
						object = event.content;
	
						for ( var i = 0, l = object.children.length; i < l; i ++ ) {
	
							object.children[ i ].material.map = texture;
	
						}
	
						deathwing.add(object);
						
						deathwing.scale.set(10,10,10);
						deathwing.rotation.setX(-Math.PI/2);
					});
					
					obj_loader.load( 'models/jiqiren.obj' );
					load_objs();
					
					//
					
					createElements();
                	loadModels();
					
               		 init();
                 	document.addEventListener( 'mousedown', onDocumentMouseDown, false );
                 	window.addEventListener( 'resize', onWindowResize, false );
                 	setInterval(animate, 15);    
                });	
				
            };
			var death=new THREE.Object3D();
			function load_objs()
			{
					var text_loader = new THREE.ImageLoader();
					text_loader.addEventListener( 'load', function ( event ) {
	
						newtext.image = event.content;
						newtext.needsUpdate = true;
	
					} );
					text_loader.load( 'textures/ash_uvgrid01.jpg' );
					var obj_loader = new THREE.OBJLoader();
					obj_loader.addEventListener( 'load', function ( event ) {
	
						sobject = event.content;
	
						for ( var i = 0, l = sobject.children.length; i < l; i ++ ) {
	
							sobject.children[ i ].material.map = texture;
	
						}
						death.add(sobject);
						death.scale.set(10,10,10);
						death.rotation.setX(-Math.PI/2);
					});
					
					obj_loader.load( 'models/deathwing.obj' );
			}
			
            // events
            function onDocumentMouseDown( event ) {
                event.preventDefault();
                var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
                projector.unprojectVector( vector, camera );    //摄像头标定，分解投影矩阵
                var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );
                var point = Models.intersect(ray);
            }
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight; //aspect 比例
                camera.updateMatrix();  // 根据改变的比例， 更新投影矩阵
            }
        </script>
    </head>
    
    <body>
        <noscript>
            <div style="display:block">
                Your browser does not support JavaScript!
            </div>
        </noscript>
        <div id="loading">
        
            loading...
        </div>
        <div id="container">

        </div>
    </body>

</html>